<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serum Preset Co-Pilot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Gradient Set A */
            --bg-start-a: #0d1117;
            --bg-end-a: #161b22;
            --opacity-a: 1;
            /* Gradient Set B */
            --bg-start-b: #0d1117;
            --bg-end-b: #161b22;
            --opacity-b: 0;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0d1117; /* Fallback color */
        }
        /* Pseudo-elements for cross-fading background gradient */
        body::before, body::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -20; /* Place behind the particle canvas */
            transition: opacity 1.5s ease-in-out;
        }
        body::before {
            background-image: linear-gradient(180deg, var(--bg-start-a) 0%, var(--bg-end-a) 100%);
            opacity: var(--opacity-a);
        }
        body::after {
            background-image: linear-gradient(180deg, var(--bg-start-b) 0%, var(--bg-end-b) 100%);
            opacity: var(--opacity-b);
        }
        .glass-card { 
            background: rgba(22, 27, 34, 0.6); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid rgba(56, 62, 74, 0.5); 
            border-radius: 1rem; 
        }
        @keyframes fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes fade-in-up { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.6s ease-out forwards; }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out both; }
        @keyframes loader-bar { 0%, 80%, 100% { transform: scaleY(0.4); opacity: 0.5; } 40% { transform: scaleY(1); opacity: 1; } }
        .animate-loader-bar { animation: loader-bar 1.2s infinite ease-in-out; }
        .generate-button {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        .generate-button:not(:disabled):hover {
            box-shadow: 0 0 20px 5px rgba(59, 130, 246, 0.3);
        }
        .generate-button:not(:disabled):active {
            transform: scale(0.98);
            box-shadow: 0 0 5px 2px rgba(59, 130, 246, 0.2);
        }
        .accordion-content, #subgenre-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .subgenre-button {
            background-color: rgba(31, 41, 55, 0.5);
            border: 1px solid rgb(75 85 99 / 0.8);
        }
        .subgenre-button.selected {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #eff6ff;
        }
    </style>
</head>
<body class="text-white">
    <canvas id="particle-canvas" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>
    
    <main class="max-w-6xl mx-auto p-4 md:p-8 relative z-10">
        <header class="text-center my-8 md:my-12 animate-fade-in">
            <h1 class="text-4xl md:text-5xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">Serum Preset Co-Pilot</h1>
            <p class="text-lg text-gray-400 mt-2">Guide the AI to craft your perfect sound.</p>
        </header>

        <!-- Guided Mode -->
        <section class="animate-fade-in" style="animation-delay: 0.2s;">
            <div class="text-center mb-4"><span class="text-lg font-semibold text-gray-300">Guided Mode</span></div>
            <div id="genre-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-10 gap-3 md:gap-4 mb-4">
                <!-- Genre cards will be injected here by JavaScript -->
            </div>
            <div id="subgenre-container" class="w-full">
                <!-- Sub-genres will be injected here -->
            </div>
        </section>
        
        <section class="glass-card p-6 my-10 animate-fade-in" style="animation-delay: 0.4s;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label for="type-select" class="block text-sm font-bold text-gray-300 mb-2 text-center md:text-left">Sound Type</label>
                    <select id="type-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                        <!-- Type options will be injected here -->
                    </select>
                </div>
                <div>
                    <label for="mood-select" class="block text-sm font-bold text-gray-300 mb-2 text-center md:text-left">Mood</label>
                    <select id="mood-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                        <!-- Mood options will be injected here -->
                    </select>
                </div>
            </div>
            <div class="mb-6">
                <label for="inspired-by-input" class="block text-sm font-bold text-gray-300 mb-2 text-center md:text-left">Inspired By (Optional)</label>
                <input type="text" id="inspired-by-input" placeholder="e.g., a Hans Zimmer pad, Flume-style chords" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
            </div>

            <!-- Divider -->
            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-gray-700"></div>
                </div>
                <div class="relative flex justify-center">
                    <span class="bg-gray-800/80 px-3 text-lg font-medium text-gray-300">OR</span>
                </div>
            </div>

            <!-- Direct Instruction Mode -->
            <div>
                <label for="custom-instruction-input" class="block text-lg font-semibold text-gray-300 mb-2 text-center">Direct Instruction</label>
                <textarea id="custom-instruction-input" rows="3" placeholder="Describe the sound you want... e.g., 'A dark, gritty reese bass for neurofunk with a metallic texture' or 'A soft, ambient pad that sounds like it's underwater'" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"></textarea>
            </div>
             
            <div class="mt-8">
                <button id="generate-button" class="generate-button w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold py-2.5 px-6 rounded-md shadow-lg disabled:bg-gray-500 disabled:from-gray-500 disabled:cursor-not-allowed flex items-center justify-center">
                    Generate Preset
                </button>
            </div>
        </section>

        <section id="results-section" class="min-h-[24rem]">
            <!-- Results will be injected here -->
        </section>
    </main>

    <script type="module">
        // --- DATA AND STATE MANAGEMENT ---
        const state = {
            selections: { 
                genre: null, 
                subgenre: null, 
                type: 'Lead', 
                mood: 'Uplifting', 
                inspiredBy: '',
                customInstruction: '' 
            },
            loading: false,
            preset: null,
            presetTitle: '',
            error: null,
            activeGradientSet: 'a', // 'a' or 'b'
        };

        const genres = [
            { name: 'House', icon: '🏠', subgenres: ['Tech House', 'Deep House', 'Progressive House', 'Afro House', 'Future House'] },
            { name: 'Techno', icon: '🎛️', subgenres: ['Melodic Techno', 'Hard Techno', 'Minimal Techno', 'Industrial Techno'] },
            { name: 'Trance', icon: '🌀', subgenres: ['Uplifting Trance', 'Psytrance', 'Progressive Trance', 'Vocal Trance'] },
            { name: 'Dubstep', icon: '🤖', subgenres: ['Riddim', 'Melodic Dubstep', 'Tearout', 'Future Riddim'] },
            { name: 'Future Bass', icon: '🎶' },
            { name: 'Lo-fi', icon: '☕' },
            { name: 'Trap', icon: '⛓️', subgenres: ['Hardwave', 'Hybrid Trap', 'Cloud Rap'] },
            { name: 'Drill', icon: '🔪', subgenres: ['UK Drill', 'NY Drill', 'Jersey Drill'] },
            { name: 'Phonk', icon: '💀', subgenres: ['Drift Phonk', 'Memphis Phonk', 'Phonk Wave'] },
            { name: 'Synthwave', icon: '🌅', subgenres: ['Darksynth', 'Outrun', 'Retrowave'] },
            { name: 'Drum & Bass', icon: '🥁', subgenres: ['Neurofunk', 'Liquid D&B', 'Jump-Up', 'Dancefloor D&B'] },
            { name: 'Hip Hop', icon: '🎤' },
            { name: 'Pop', icon: '🌟', subgenres: ['Synth-Pop', 'Hyperpop', 'K-Pop', 'Dance-Pop'] },
            { name: 'R&B', icon: '💖', subgenres: ['Contemporary R&B', 'Alternative R&B'] },
            { name: 'Soul', icon: '🎷', subgenres: ['Neo-Soul', 'Modern Soul', 'Psychedelic Soul'] },
            { name: 'Indie', icon: '🎸', subgenres: ['Indie Pop', 'Indie Rock', 'Dream Pop'] },
            { name: 'Folk', icon: '🪕', subgenres: ['Indie Folk', 'Folk-Pop', 'Traditional Folk'] },
            { name: 'Cinematic', icon: '🎬' },
            { name: 'Ambient', icon: '🌌' },
            { name: 'Hyperpop', icon: '✨' },
        ];
        const presetTypes = ['Lead', 'Bass', 'Pad', 'Keys', 'Pluck', 'Arp', 'FX', 'Synth', 'Strings', 'Brass', 'Bell', 'Piano', 'Woodwind', 'Chord'];
        const presetMoods = ['Aggressive', 'Ambient', 'Chill', 'Cinematic', 'Club', 'Dance', 'Dark', 'Dreamy', 'Dynamic', 'Energetic', 'Experimental', 'Funky', 'Groovy', 'Happy', 'Intense', 'Mellow', 'Nostalgic', 'Party', 'Sad', 'Smooth', 'Soothing', 'Uplifting'];
        
        const moodThemes = {
            'Default': ['#0d1117', '#161b22'], 
            'Uplifting': ['#0d1117', '#1a2a45'], 
            'Happy': ['#111827', '#4a3a1f'], 
            'Party': ['#111827', '#4d1a3d'], 
            'Club': ['#0d1117', '#3d1a4d'], 
            'Sad': ['#111827', '#1f2937'], 
            'Mellow': ['#111827', '#1e3a3a'], 
            'Chill': ['#0d1117', '#1a3a3a'], 
            'Dark': ['#0d1117', '#221616'], 
            'Aggressive': ['#111827', '#451a1a'], 
            'Nostalgic': ['#111827', '#3a3a1f'], 
            'Experimental': ['#111827', '#3a1f4a'], 
            'Cinematic': ['#0d1117', '#1f2937'], 
            'Dance': ['#111827', '#4d1a4d'], 
            'Groovy': ['#111827', '#4a3a1f'],
            'Ambient': ['#0d1117', '#1a3a3a'],
            'Dynamic': ['#0d1117', '#3d1a4d'],
            'Energetic': ['#111827', '#4a3a1f'],
            'Funky': ['#111827', '#4d1a3d'],
            'Smooth': ['#111827', '#1f2937'],
            'Soothing': ['#111827', '#1e3a3a'],
            'Dreamy': ['#111827', '#3a1f4a'],
            'Intense': ['#111827', '#451a1a'],
        };

        const serumWavetables = {
            'Analog': ['Acid', 'Analog_BD_Sin', 'Basic Mg', 'Basic Mini', 'Basic Shapes', 'Basic_Cjw', 'Basic_McB', 'Basic_Mdc', 'Basic_Wrd', 'BS2 - Acid', 'BS2 - Filthy', 'BS2 - Subby Saw', 'BSOD_Square', 'DS Saw and Tri', 'Jno', 'MATRIXY C64', 'MB Saw', 'MB Triangle (Metal)', 'Mellow But Instable', 'MiniBass', 'MsAw', 'MsPw', 'PWM C64', 'PWM DS', 'PWM Genji', 'PWM Inception', 'PWM Juno', 'PWM LPF', 'PWM Maths 2', 'PWM Maths', 'PWM MedicineHat', 'PWM MG', 'PWM Mini', 'PWM Reso', 'PWM Restricted', 'PWM Trench', 'PWM_Mdc', 'SawRounded', '808 Harms', '808 Kick', 'AT Alter', 'AT Analog Four', 'AT ARP 2600', 'AT DFAM', 'AT Dixie', 'AT Easel Mod Osc', 'AT Entity', 'AT Furth Mood Symmetry', 'AT Furthrrrr', 'AT Harmonic Oscillator Mixer', 'AT Juno 106', 'AT Loquelic iteritas PM', 'AT Loquelic lteritas SS', 'AT Matriarch', 'AT Model 10', 'AT Model D', 'AT Mopho x4', 'AT Mother 32', 'AT Perfourmer MKI', 'AT Plaits Modal', 'AT Plaits Wavetable', 'AT Promars', 'AT Spectrum', 'AT VCO', 'DM-OSCAR', 'DM FMOD 01', 'DM FMOD 02', 'HW -OsC', 'Jungle 808', 'Mello', 'Modular18', 'MWoog', 'No Fund Tri Saw Sq', 'Perfect 808 Sub Shapes', 'PolySaw', 'Saw Alice', 'Saw Drift 303'],
            'Digital': ['Anti-Stasis', 'bipole_harmonic', 'BottleBlow', 'CrushWub', 'Debussy', 'DirtySaw', 'Dist 8bit Fwap', 'Dist Bass Dropper', 'Dist C2', 'Dist d00t', 'Dist Fwapper SQ', 'Dist Sub Dskperc', 'Dist WaTech', 'Dull_toy', 'Ethos', 'Evol Longreece', 'Evol Sweep', 'Evolution', 'FFT_Add_2nds', 'FFT_Add_3rds', 'FFT_Add_4ths', 'FFT_Animal 1', 'FFT_SQUEAL', 'FMFM', 'FM_Freak', 'FM_Splat', 'Gritty', 'GS-xello', 'Harmonic Morph', 'Harmonic Subtle', 'HarmonicSeries', 'Hoo', 'Hypa', 'ICanHaskick', 'Kream', 'Mario', 'Misfits', 'PerfectSQSteps', 'Prime', 'PWM Electro', 'PWM Weird', 'Razor', 'Reese', 'Ring', 'Scream', 'Shrats', 'Sludgecrank', 'SSQ', 'SubBass_1', 'Tigra', 'VintageSynth', 'Voxu', 'Waveterminal', 'Weow', 'Wraith', 'Yoy64', '4 Partials All Combos', '6 Partials All Combos', 'Additive Talk', 'AM Sine Harmonics', 'Bark', 'Basic OPL', 'Bass Pluck', 'Belladonna', 'Big Slab', 'Bitspeek 2 Seperate', 'Braids Bell Pluck', 'Brass Stab', 'C Morph', 'Chord', 'Dinosaurs', 'DisHarm', 'DX Brass 2', 'DX Hard Attack', 'Dying Saw', 'Dying Sine', 'Dying Square', 'Electric Noise', 'FB', 'Fish flips and morphs into Swordfish', 'FM Careful Triangle', 'FM Dangerous Saw 2', 'FM Dangerous Saw', 'FM Dirty Square', 'FM Piano', 'FM Sine Hell', 'Generative Waves', 'GS Jharp', 'Gtr Harmnx', 'Hand Drawn EBass', 'Hardware Waveforms', 'Harm Octave', 'Harmonic Series Smooth', 'Harmonic Squares', 'Harmonize the q', 'Harsh Harm', 'HyperSqueak', 'IcanGPT', 'JF Flute', 'Lately', 'Memory Organ', 'Morpheus', 'Mr Bruce Lee', 'No Fundamental Saw', 'Only H1', 'Only H2', 'Ooomph', 'Organ Cluster', 'Piano', 'Pieceful', 'Porta Waves', 'Random Partials', 'RCM Bass 1', 'RCM Bass 2', 'Renegade', 'Rich Pluck', 'RMrk1 Key Up', 'RMrK1 Tine', 'RMrk1', 'Shep. Oct+Fifths', 'Shep, Octaves', 'Sine SuperChirp', 'Sine with Benefits', 'Softest Growl', 'Squibble', 'Talking Vox', 'Toucan', 'TrickTreat', 'Tubular', 'Vibing', 'Vocal Hum', 'Voice Simple', 'Voxy'],
            'Spectral': ['AlienSpectral', 'Bowed Metal', 'Trilobyte 1', 'Trilobyte 2', 'Trilobyte 3', 'Creeper', 'Electric Guitar', 'Gremlin', 'Grimace', 'Light Metal 1', 'Monster 1', 'Monster 2', 'Monster 3', 'Monster A', 'Monster 5', 'Monster 6', 'Monster 7', 'Monster 8', 'Monster 9', 'Oddpass', 'Phase Werb', 'Reesey Mess 1', 'Reesey Mess 2', 'Reesey Mess 3', 'Reesey Mess 4', 'Reesey Mess 5', 'Scout', 'Solid Phase 1', 'Solid Phase 2', 'Squelchy 1', 'Squelchy 2', 'Squelchy 3', 'Squelchy FM 1', 'Squelchy FM 2', 'Thin Thick'],
            'Vowel': ['Allophones', 'DudaChoir', 'E_Yeah', 'Fred Like Bass', 'ML Addifunk', 'Native Curse', 'OOH YAH 00', 'LLI', 'Retro Speaking', 'SAM SERUM', 'SAM Speaks', 'WahWah']
        };
        const serumNoises = {
            'Analog': ['AlphaNz', 'ARP circult', 'ARP pink', 'ARP white', 'BrightWhite', 'J60', 'J8', 'J106 Chorus', 'J106 HP', 'J106 HP_Cho', 'J106', 'Micrkrg Noise', 'OrganNolise', 'SH1 Noise', 'SID drone', 'SID noise', 'SID whine'],
            'Organics': ['AC hum1', 'AC hum2', 'Air Can 1', 'Air Can 2', 'Air Can 3', 'Air Can 4', 'Air Can 5', 'CymLoop', 'CymMicBleed', 'H-Breath', 'Paper Bag', 'S-Sound', 'Shush 1', 'Shush 2', 'Squeeky', 'WindChimes'],
            'S2 Noises': ['808 Transient', 'Arctic Visit', 'Blip', 'Cicadas', 'Crackle', 'Egtr Mute', 'Egtr Neck Down', 'Egtr Neck Up', 'Fizz', 'FretNoise A', 'FretNoise B', 'FretNoise C', 'HP12 Pink Noise (Mono)', 'HP12 Pink Noise (Stereo)', 'HP12 White Noise (Stereo)', 'Keys and Ball', 'Pebbles in Tube', 'Radio Glitch', 'Rain 100 Hgh', 'Rising Wind', 'SaW', 'Screws in Bowl', 'Sine Wave C', 'Stretched Vlnyl', 'Vinyl Crackle', 'Whif'],
            'SOR': ['Analog Flow', 'Atmos 05', 'Atmos 07', 'Atmos 11', 'Atmos 14', 'Atmos 18', 'Atmos 20', 'Atmos 44', 'Atmos 45', 'Atmos 47', 'Atmos 52', 'Bonecrusher', 'Dark Phuture', 'Electric Bubbles', 'Electricity', 'Elysium', 'FX5', 'Horns Of Fear', 'Horrorwind', 'Metalmaster', 'Place f Fear', 'Polar 1', 'Polar 2', 'Prophecy', 'Rising', 'Strange Flow', 'Waterworld'],
            'Color': ['White', 'Pink', 'Brown', 'Geiger'],
            'Acoustic': ['Breathy Pianoish', 'EPiano Chord', 'Piano High Long Tail', 'Piano Middle C', '44', 'Piano', 'Sympathy Piano C4', 'Aztec Pipe', 'Betty', 'Flute Delay', 'Flute Fula Long', 'Flute Fula', 'Flute Long Stab', 'Flute Long Vibrato', 'Flute Rainforest', 'Flute Staccato', 'Flute Virtual', 'Flute Warm', 'Pan Flute', 'Savanna', 'Brass WallLow', 'Horn Stab Emin', 'Trombone Alt', 'II', 'stc A#1', 'GG3', 'Trombone short', 'Trombone short stc', 'Trombone', 'Tuba short stc G1', 'Celli ColLegno F#1', 'Celli Short G#2', 'Cello Finger Gliss UpC2', 'Doubled Tension', 'Doubled Vibrato', 'Erhu', 'Horsehead Fiddle', 'Morin Khuur Sustained', 'Strings Crystal Joy', 'Strings Heady', 'Strings Oblinas', 'Unhappy Chatty Cello', 'Upright Bass rco Long', 'Upright Bass Arco Short', 'ViolinsHalf Harm Glissh E5']
        };
        
        const categorizedAcousticSamples = {
            'Piano': ['Breathy Pianoish', 'EPiano Chord', 'Piano High Long Tail', 'Piano Middle C', '44', 'Piano', 'Sympathy Piano C4'],
            'Woodwind': ['Aztec Pipe', 'Betty', 'Flute Delay', 'Flute Fula Long', 'Flute Fula', 'Flute Long Stab', 'Flute Long Vibrato', 'Flute Rainforest', 'Flute Staccato', 'Flute Virtual', 'Flute Warm', 'Pan Flute', 'Savanna'],
            'Brass': ['Brass WallLow', 'Horn Stab Emin', 'Trombone Alt', 'II', 'stc A#1', 'GG3', 'Trombone short', 'Trombone short stc', 'Trombone', 'Tuba short stc G1'],
            'Strings': ['Celli ColLegno F#1', 'Celli Short G#2', 'Cello Finger Gliss UpC2', 'Doubled Tension', 'Doubled Vibrato', 'Erhu', 'Horsehead Fiddle', 'Morin Khuur Sustained', 'Strings Crystal Joy', 'Strings Heady', 'Strings Oblinas', 'Unhappy Chatty Cello', 'Upright Bass rco Long', 'Upright Bass Arco Short', 'ViolinsHalf Harm Glissh E5']
        };

        const allValidWavetables = Object.entries(serumWavetables).flatMap(([category, tables]) => tables.map(table => `${category} > ${table}`));
        const allValidNoises = Object.entries(serumNoises).flatMap(([category, noises]) => noises.map(noise => `${category} > ${noise}`));

        // --- DOM ELEMENTS ---
        const genreGrid = document.getElementById('genre-grid');
        const subgenreContainer = document.getElementById('subgenre-container');
        const typeSelect = document.getElementById('type-select');
        const moodSelect = document.getElementById('mood-select');
        const inspiredByInput = document.getElementById('inspired-by-input');
        const customInstructionInput = document.getElementById('custom-instruction-input');
        const generateButton = document.getElementById('generate-button');
        const resultsSection = document.getElementById('results-section');

        // --- UI RENDERING FUNCTIONS ---

        /**
         * Renders the initial UI components like genre grid and dropdowns.
         */
        function renderInitialUI() {
            genreGrid.innerHTML = genres.map(g => `
                <button data-genre="${g.name}" class="group relative flex flex-col items-center justify-center p-4 rounded-2xl transition-all duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-400">
                    <div class="absolute inset-0 rounded-2xl bg-gray-800/60 group-hover:bg-gray-700/80 transition-all duration-300"></div>
                    <div class="absolute inset-0 rounded-2xl border border-gray-700 group-hover:border-gray-600 transition-all duration-300"></div>
                    <div class="absolute inset-0 rounded-2xl shadow-none group-hover:shadow-[0_0_15px_rgba(59,130,246,0.2)] transition-all duration-500"></div>
                    <div class="relative z-10 flex flex-col items-center justify-center space-y-3">
                        <span class="text-3xl">${g.icon}</span>
                        <span class="font-semibold text-sm text-center text-gray-300 group-hover:text-white transition-colors duration-300">${g.name}</span>
                    </div>
                </button>
            `).join('');

            typeSelect.innerHTML = presetTypes.map(t => `<option value="${t}">${t}</option>`).join('');
            typeSelect.value = state.selections.type;

            moodSelect.innerHTML = presetMoods.map(m => `<option value="${m}">${m}</option>`).join('');
            moodSelect.value = state.selections.mood;
            
            updateResultsUI();
        }

        /**
         * Renders the sub-genre buttons for a selected genre.
         * @param {string} genreName - The name of the selected genre.
         */
        function renderSubgenres(genreName) {
            const genre = genres.find(g => g.name === genreName);
            if (genre && genre.subgenres) {
                const subgenreHTML = `
                    <div class="text-center mb-3 text-gray-400 animate-fade-in">Sub-Genre (Optional)</div>
                    <div class="flex flex-wrap justify-center gap-3 animate-fade-in">
                        ${genre.subgenres.map(sg => `
                            <button data-subgenre="${sg}" class="subgenre-button text-gray-300 font-semibold py-2 px-4 rounded-full transition-colors duration-200 hover:bg-gray-700/70 hover:border-gray-500">
                                ${sg}
                            </button>
                        `).join('')}
                    </div>
                `;
                subgenreContainer.innerHTML = subgenreHTML;
                subgenreContainer.style.maxHeight = subgenreContainer.scrollHeight + "px";
                subgenreContainer.classList.add('mt-6');
            } else {
                subgenreContainer.style.maxHeight = '0';
                subgenreContainer.classList.remove('mt-6');
                subgenreContainer.innerHTML = '';
            }
        }

        /**
         * Updates the results section based on the current application state (loading, error, preset, or initial).
         * This function is now more robust to prevent rendering leaked instructions from the AI.
         */
        function updateResultsUI() {
            if (state.loading) {
                resultsSection.innerHTML = `<div class="flex justify-center items-center p-8"><div class="w-12 h-12"><div class="animate-pulse flex space-x-1"><div class="w-3 h-12 bg-blue-400 rounded-full animate-loader-bar" style="animation-delay: 0s"></div><div class="w-3 h-12 bg-blue-400 rounded-full animate-loader-bar" style="animation-delay: 0.1s"></div><div class="w-3 h-12 bg-blue-400 rounded-full animate-loader-bar" style="animation-delay: 0.2s"></div></div></div></div>`;
                return;
            }
            if (state.error) {
                resultsSection.innerHTML = `<div class="glass-card p-4 text-center text-red-400">${state.error}</div>`;
                return;
            }
            if (state.preset) {
                // A whitelist of valid section titles to render. This prevents any unwanted instructional text from being displayed.
                const validSections = ['PRESET DESCRIPTION', 'TIMBRE GOAL', 'OSC A', 'OSC B', 'SUB OSCILLATOR', 'NOISE OSCILLATOR', 'FILTER', 'VOICING', 'ARPEGGIATOR', 'ENV 1 (AMP)', 'GLOBAL SETTINGS', 'MODULATION MATRIX', 'FX RACK', 'MACRO CONTROLS'];
                
                const sections = state.preset.split('###').filter(Boolean); // Filter out empty strings
                
                const presetHTML = sections.map((section, index) => {
                    const lines = section.trim().split('\n');
                    const titleLine = lines.shift() || '';
                    const title = titleLine.trim().replace(/#/g, '').toUpperCase();
                    
                    // Only render sections that are in our whitelist.
                    if (!validSections.includes(title)) {
                        return '';
                    }

                    const content = lines.filter(line => line.trim() !== '' && line.includes(':'));
                    if (content.length === 0) return '';
                    
                    const listItems = content.map(line => {
                        const [key, ...valueParts] = line.split(':');
                        return `<li class="text-gray-300 text-sm p-2 rounded-md"><span><strong class="font-semibold text-gray-200">${key.trim()}:</strong> ${valueParts.join(':').trim()}</span></li>`;
                    }).join('');

                    return `<div class="glass-card mb-4 animate-fade-in-up" style="animation-delay: ${index * 50}ms"><button class="accordion-toggle w-full flex justify-between items-center p-4 text-left"><h3 class="text-lg font-bold text-blue-300">${title.charAt(0) + title.slice(1).toLowerCase()}</h3><svg class="w-6 h-6 text-gray-400 transform transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" /></svg></button><div class="accordion-content px-4 pb-4"><ul class="space-y-2 border-t border-gray-700/50 pt-3">${listItems}</ul></div></div>`;
                }).join('');

                resultsSection.innerHTML = `<div class="animate-fade-in"><h2 class="text-2xl font-bold text-center mb-6 text-white"><span class="text-blue-400">${state.presetTitle}</span></h2>${presetHTML}</div>`;
            } else {
                resultsSection.innerHTML = `<div class="flex items-center justify-center h-full min-h-[24rem] animate-fade-in" style="animation-delay: 0.6s;"><div class="text-center glass-card p-8"><h3 class="text-lg font-semibold text-gray-200">Follow the steps above to begin</h3><p class="text-gray-400 mt-1">Your unique preset guide will appear here.</p></div></div>`;
            }
            attachAccordionListeners();
        }
        
        // --- EVENT HANDLERS ---
        function handleGenreSelect(e) {
            const button = e.target.closest('button[data-genre]');
            if (!button) return;
            
            // Clear custom instruction when using guided mode
            customInstructionInput.value = '';
            state.selections.customInstruction = '';

            const genreName = button.dataset.genre;
            state.selections.genre = genreName;
            state.selections.subgenre = null;

            document.querySelectorAll('#genre-grid button').forEach(btn => {
                const container = btn.children[0];
                const border = btn.children[1];
                const shadow = btn.children[2];
                if (btn.dataset.genre === genreName) {
                    btn.classList.add('scale-105');
                    container.classList.add('bg-blue-500/20', 'group-hover:bg-blue-500/30');
                    container.classList.remove('bg-gray-800/60', 'group-hover:bg-gray-700/80');
                    border.classList.add('border-blue-400');
                    border.classList.remove('border-gray-700', 'group-hover:border-gray-600');
                    shadow.classList.add('shadow-[0_0_20px_rgba(59,130,246,0.5)]');
                } else {
                    btn.classList.remove('scale-105');
                    container.classList.remove('bg-blue-500/20', 'group-hover:bg-blue-500/30');
                    container.classList.add('bg-gray-800/60', 'group-hover:bg-gray-700/80');
                    border.classList.remove('border-blue-400');
                    border.classList.add('border-gray-700', 'group-hover:border-gray-600');
                    shadow.classList.remove('shadow-[0_0_20px_rgba(59,130,246,0.5)]');
                }
            });
            
            renderSubgenres(genreName);
            updateGenerateButtonState();
        }

        function clearGenreSelection() {
            state.selections.genre = null;
            state.selections.subgenre = null;
            document.querySelectorAll('#genre-grid button').forEach(btn => {
                const container = btn.children[0];
                const border = btn.children[1];
                const shadow = btn.children[2];
                btn.classList.remove('scale-105');
                container.classList.remove('bg-blue-500/20', 'group-hover:bg-blue-500/30');
                container.classList.add('bg-gray-800/60', 'group-hover:bg-gray-700/80');
                border.classList.remove('border-blue-400');
                border.classList.add('border-gray-700', 'group-hover:border-gray-600');
                shadow.classList.remove('shadow-[0_0_20px_rgba(59,130,246,0.5)]');
            });
            renderSubgenres(null);
        }
        
        function handleSubgenreSelect(e) {
            const button = e.target.closest('button[data-subgenre]');
            if(!button) return;

            const subgenreName = button.dataset.subgenre;
            
            if (button.classList.contains('selected')) {
                button.classList.remove('selected');
                state.selections.subgenre = null;
            } else {
                document.querySelectorAll('#subgenre-container button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                button.classList.add('selected');
                state.selections.subgenre = subgenreName;
            }
        }

        function attachAccordionListeners() {
            document.querySelectorAll('.accordion-toggle').forEach(button => {
                const content = button.nextElementSibling;
                const icon = button.querySelector('svg');
                if (content && !content.style.maxHeight) {
                     icon.style.transform = '';
                }

                button.onclick = () => {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    
                    if (content && icon) {
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                            icon.style.transform = '';
                        } else {
                            document.querySelectorAll('.accordion-content').forEach(acc => {
                                acc.style.maxHeight = null;
                                if (acc.previousElementSibling) {
                                    const prevIcon = acc.previousElementSibling.querySelector('svg');
                                    if(prevIcon) prevIcon.style.transform = '';
                                }
                            });
                            content.style.maxHeight = content.scrollHeight + "px";
                            icon.style.transform = 'rotate(180deg)';
                        }
                    }
                };
            });
        }

        function updateGenerateButtonState() {
            const isGuidedValid = !!state.selections.genre;
            const isDirectValid = state.selections.customInstruction.trim() !== '';
            generateButton.disabled = !isGuidedValid && !isDirectValid;
        }

        // --- API & LOGIC ---

        /**
         * Generates the master prompt for the AI, including all rules, knowledge bases, and the user's request.
         * @param {object} selections - The user's current selections (genre, type, etc.).
         * @returns {string} The complete prompt to be sent to the AI model.
         */
        const getCreativePrompt = (selections) => {
            const { genre, subgenre, type, mood, inspiredBy, customInstruction } = selections;
            
            const proSoundDesignRules = `
                **NON-NEGOTIABLE PROFESSIONAL SOUND DESIGN RULES:**
                1.  **Envelopes MUST Match Sound Type:** The shape of ENV 1 (AMP) is critical and is not optional.
                    -   If Type is 'Pluck', 'Keys', 'Bell', or 'Piano': Attack MUST be < 10ms, Sustain MUST be -inf dB, and Decay must be < 800ms.
                    -   If Type is 'Pad' or 'Strings': Attack MUST be > 400ms, Sustain MUST be > -10dB, and Release must be > 1s.
                    -   If Type is 'Bass': Can be plucky (see above) or sustained (fast Attack, high Sustain). Choose one and stick to it.
                2.  **FX Chain Order MUST Be Logical:** You MUST order the FX Rack logically. The correct order is: DYNAMICS/SHAPING (Distortion, Compressor, EQ) -> MODULATION (Chorus, Flanger, Phaser) -> TIME/SPACE (Delay, Reverb). It is a major error to place Reverb before Distortion.
                3.  **Presets MUST Be Expressive:** Every preset must be playable and dynamic.
                    -   **Velocity:** You MUST map Velocity to both Master Volume (AMP) and Filter Cutoff in the Mod Matrix. This is not optional.
                    -   **ModWheel:** You MUST map the ModWheel to a useful, expressive parameter (e.g., Filter Cutoff, LFO Rate, FX Mix).
                4.  **Wavetables MUST Be Foundational for Core Sounds:**
                    -   If Type is 'Bass', 'Pad', 'Pluck', or 'Keys', OSC A's wavetable MUST be 'Analog > Basic Shapes' unless the specific genre guide explicitly requires another wavetable. This is a foundational rule.
                5.  **Iconic Recipes MUST Be Followed:**
                    -   **Reese Bass:** If making a Reese, you MUST use two Saw waves (from 'Analog > Basic Shapes') and detune them against each other.
                    -   **Supersaw:** If making a supersaw, you MUST use a Saw wave with Unison > 7 and significant Detune.
            `;
            
            const serumFxKnowledge = `**Serum FX Knowledge Base (Hyper-Specific):**
- **Distortion:** Types: Tube, Softclip, Hardclip, Diode 1, Diode 2, Linear fold, Sin fold, Zero-Square, DownSample, Asym, Rectify, X-Shaper, X-Shaper (Asym), Sine Shaper, Stomp Box, Tape Saturation, Overdrive, Soft Saturation.
- **Reverb:** Types: Plate, Hall, Vintage, Nitrous, Basin.
- **Delay:** Modes: Normal, Ping-Pong.
- **Compressor:** Modes: Single, Multiband (OTT).
- **Other FX:** EQ, Chorus, Flanger, Phaser, Hyper/Dimension.`;

            const serumNoiseKnowledge = `**Serum Noise Knowledge Base:**
- Categories: Analog, Organics, S2 Noises, SOR, Color, Acoustic.`;

            const serumFilterKnowledge = `**Serum Filter Knowledge Base:**
- Categories: Normal Lowpass (MG, French, German, Acid), Normal Highpass, Normal Band/Peak/Notch, Multi, Flanges/Misc (Comb, Flg, Allpass, Reverb, Scream, Dist.Comb).`;

            const outputTemplate = `
### PRESET NAME
- Name: 

### PRESET DESCRIPTION
- Description: 

### TIMBRE GOAL
- Goal: 

### OSC A
- Wavetable: 
- Rationale: 
- Octave: 
- Semitone: 
- Fine Tune: 
- Wavetable Position: 
- Unison: 
- Detune: 
- Blend: 
- Pan: 
- Level: 
- Warp Mode 1: 
- Warp Mode 2: 

### OSC B
- Wavetable: 
- Rationale: 
- Octave: 
- Semitone: 
- Fine Tune: 
- Wavetable Position: 
- Unison: 
- Detune: 
- Blend: 
- Pan: 
- Level: 
- Warp Mode 1: 
- Warp Mode 2: 

### SUB OSCILLATOR
- Enabled: 
- Waveform: 
- Octave: 
- Level: 
- Direct Out: 

### NOISE OSCILLATOR
- Type: 
- Pitch: 
- Level: 

### FILTER
- Type: 
- Rationale: 
- Cutoff: 
- Resonance: 
- Drive: 

### VOICING
- Polyphony: 
- Mono: 
- Legato: 
- Portamento: 

${type === 'Arp' ? `### ARPEGGIATOR
- Mode: 
- Rate: 
- Octave Range: 
- Gate: 
- Swing: 
` : ''}

### ENV 1 (AMP)
- Attack: 
- Decay: 
- Sustain: 
- Release: 

### GLOBAL SETTINGS
- Chaos 1 (Pitch Drift): 
- Chaos 2 (Parameter Drift): 

### MODULATION MATRIX
- Routing 1 Source: 
- Routing 1 Destination: 
- Routing 1 Amount: 
- Routing 2 Source: 
- Routing 2 Destination: 
- Routing 2 Amount: 
- Routing 3 Source: 
- Routing 3 Destination: 
- Routing 3 Amount: 

### FX RACK
- Slot 1: 
- Slot 1 Rationale: 
- Slot 2: 
- Slot 2 Rationale: 
- (Slot 3): 
- (Slot 3 Rationale): 
- (Slot 4): 
- (Slot 4 Rationale): 

### MACRO CONTROLS
- Macro 1 Purpose: 
- Macro 1 -> Destination 1: 
- Macro 1 -> Range 1: 
- Macro 2 Purpose: 
- Macro 2 -> Destination 1: 
- Macro 2 -> Range 1: 
- (Macro 3 Purpose): 
- (Macro 3 -> Destination 1): 
- (Macro 3 -> Range 1): 
- (Macro 4 Purpose): 
- (Macro 4 -> Destination 1): 
- (Macro 4 -> Range 1): 
`;
            
            let coreRequest;
            if (customInstruction.trim() !== '') {
                coreRequest = `**CORE REQUEST:** A user has provided a direct instruction for a sound. Fulfill this request to the best of your ability, inferring the sound type, genre, and character from their words.
- User's Instruction: "${customInstruction}"`;
            } else {
                const fullGenre = subgenre ? `${subgenre}` : genre;
                coreRequest = `**CORE REQUEST:**
- Genre: **${fullGenre}**
- Sound Type: **${type}**
- Mood: **${mood}**
- Inspiration: ${inspiredBy || 'None'}`;
            }

            return `You are a world-class sound designer using Xfer Records Serum. Your task is to create a single, highly detailed, creative, and professionally-authentic preset by filling out the template below.

${coreRequest}

**INSTRUCTIONS:**
First, study the **NON-NEGOTIABLE PROFESSIONAL SOUND DESIGN RULES** below. These are mandatory. Then, consult the reference knowledge for guidance. Your final output must ONLY be the completed template. Do not include any other text or explanations outside of the designated "Rationale" fields.

${proSoundDesignRules}

**REFERENCE KNOWLEDGE:**
${serumFxKnowledge}
${serumNoiseKnowledge}
${serumFilterKnowledge}

**FILL OUT THIS TEMPLATE:**
${outputTemplate}
`;
        };

        /**
         * Fetches a preset from the AI model and updates the application state.
         */
        async function generatePreset() {
            if (!state.selections.genre && state.selections.customInstruction.trim() === '') {
                state.error = "Please select a genre or provide a custom instruction.";
                updateResultsUI();
                return;
            }
            state.loading = true;
            state.preset = null;
            state.presetTitle = '';
            state.error = null;
            updateResultsUI();

            const prompt = getCreativePrompt(state.selections);

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyB6FOCL3qtHz2dlaNvlPHM8jQh-g16L_L0"; // API key is proxied by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API call failed: ${response.status}. Response: ${errorBody}`);
                }
                const result = await response.json();

                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    let fullText = result.candidates[0].content.parts[0].text;
                    
                    const correctedText = validateAndCorrect(fullText);
                    const nameMatch = correctedText.match(/### PRESET NAME\s*\n-\s*Name:\s*(.*)/i);
                    state.presetTitle = nameMatch ? nameMatch[1].trim() : `Custom Preset`;
                    state.preset = correctedText;
                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error('The model did not return a valid preset. This might be due to content restrictions or an API error.');
                }
            } catch (err) {
                console.error("Error during preset generation:", err);
                state.error = err.message;
            } finally {
                state.loading = false;
                updateResultsUI();
            }
        }

        /**
         * Validates and corrects the AI-generated preset text to ensure it uses valid Serum parameters.
         * This acts as a safety net to enforce rules the AI might miss.
         * @param {string} text - The raw text output from the AI model.
         * @returns {string} The corrected and validated preset text.
         */
        const validateAndCorrect = (text) => {
            const foundationalTypes = ['Bass', 'Pad', 'Pluck', 'Keys'];
            const acousticTypes = ['Piano', 'Brass', 'Strings', 'Woodwind'];
            const selectedType = state.selections.type;

            const lines = text.split('\n');
            let currentSection = '';

            const correctedLines = lines.map(line => {
                if (line.trim().startsWith("###")) {
                    currentSection = line.trim().toUpperCase();
                }

                // --- Wavetable Validation ---
                if (line.trim().startsWith('- Wavetable:')) {
                    const [key, ...valueParts] = line.split(':');
                    let value = valueParts.join(':').trim();

                    if (!allValidWavetables.includes(value)) {
                        if (currentSection === '### OSC A' && foundationalTypes.includes(selectedType)) {
                            console.warn(`Correction: Invalid wavetable '${value}' for foundational type in OSC A. Forcing 'Analog > Basic Shapes'.`);
                            return `${key}: Analog > Basic Shapes`;
                        }
                        console.warn(`Correction: Invalid wavetable '${value}'. Defaulting to 'Analog > Basic Shapes'.`);
                        return `${key}: Analog > Basic Shapes`;
                    }
                    return line;
                }

                // --- Noise Oscillator Validation ---
                if (currentSection === '### NOISE OSCILLATOR' && line.trim().startsWith('- Type:')) {
                    const [key, ...valueParts] = line.split(':');
                    let value = valueParts.join(':').trim();
                    let correctedValue = value;

                    if (acousticTypes.includes(selectedType)) {
                        const sampleName = value.split(' > ')[1] || '';
                        const correctCategorySamples = categorizedAcousticSamples[selectedType] || [];
                        if (!correctCategorySamples.includes(sampleName)) {
                            const randomCorrectSample = correctCategorySamples[Math.floor(Math.random() * correctCategorySamples.length)];
                            correctedValue = `Acoustic > ${randomCorrectSample}`;
                        }
                    }

                    if (!allValidNoises.includes(correctedValue)) {
                        const randomNoise = allValidNoises[Math.floor(Math.random() * allValidNoises.length)];
                        correctedValue = randomNoise;
                    }
                    
                    if (correctedValue !== value) {
                         console.warn(`Correction: Invalid noise sample '${value}'. Corrected to '${correctedValue}'.`);
                    }

                    return `${key}: ${correctedValue}`;
                }

                return line;
            });

            return correctedLines.join('\n');
        };

        // --- PARTICLE BACKGROUND ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particleCount = Math.floor((canvas.width * canvas.height) / 15000);
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 1.5 + 0.5, speedX: Math.random() * 0.4 - 0.2, speedY: Math.random() * 0.4 - 0.2, opacity: Math.random() * 0.5 + 0.2 });
            }
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.x += p.speedX; p.y += p.speedY;
                if (p.x > canvas.width || p.x < 0) p.speedX *= -1;
                if (p.y > canvas.height || p.y < 0) p.speedY *= -1;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`; ctx.fill();
            });
            requestAnimationFrame(animateParticles);
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            renderInitialUI();
            updateGenerateButtonState(); // Initial check

            genreGrid.addEventListener('click', handleGenreSelect);
            subgenreContainer.addEventListener('click', handleSubgenreSelect);
            typeSelect.addEventListener('change', (e) => state.selections.type = e.target.value);
            moodSelect.addEventListener('change', (e) => {
                state.selections.mood = e.target.value;
                const [start, end] = moodThemes[state.selections.mood] || moodThemes['Default'];
                
                const rootStyle = document.documentElement.style;
                
                if (state.activeGradientSet === 'a') {
                    rootStyle.setProperty('--bg-start-b', start);
                    rootStyle.setProperty('--bg-end-b', end);
                    rootStyle.setProperty('--opacity-a', '0');
                    rootStyle.setProperty('--opacity-b', '1');
                    state.activeGradientSet = 'b';
                } else {
                    rootStyle.setProperty('--bg-start-a', start);
                    rootStyle.setProperty('--bg-end-a', end);
                    rootStyle.setProperty('--opacity-b', '0');
                    rootStyle.setProperty('--opacity-a', '1');
                    state.activeGradientSet = 'a';
                }
            });
            inspiredByInput.addEventListener('input', (e) => state.selections.inspiredBy = e.target.value);
            
            customInstructionInput.addEventListener('input', (e) => {
                state.selections.customInstruction = e.target.value;
                if (e.target.value.trim() !== '') {
                    clearGenreSelection();
                }
                updateGenerateButtonState();
            });

            generateButton.addEventListener('click', generatePreset);
            resizeCanvas();
            animateParticles();
            window.addEventListener('resize', resizeCanvas);
        };
    </script>
</body>
</html>
