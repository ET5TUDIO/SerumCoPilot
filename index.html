<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serum Preset Co-Pilot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Gradient Set A */
            --bg-start-a: #0d1117;
            --bg-end-a: #161b22;
            --opacity-a: 1;
            /* Gradient Set B */
            --bg-start-b: #0d1117;
            --bg-end-b: #161b22;
            --opacity-b: 0;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0d1117; /* Fallback color */
        }
        /* Pseudo-elements for cross-fading background gradient */
        body::before, body::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -20; /* Place behind the particle canvas */
            transition: opacity 1.5s ease-in-out;
        }
        body::before {
            background-image: linear-gradient(180deg, var(--bg-start-a) 0%, var(--bg-end-a) 100%);
            opacity: var(--opacity-a);
        }
        body::after {
            background-image: linear-gradient(180deg, var(--bg-start-b) 0%, var(--bg-end-b) 100%);
            opacity: var(--opacity-b);
        }
        .glass-card { 
            background: rgba(22, 27, 34, 0.6); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid rgba(56, 62, 74, 0.5); 
            border-radius: 1rem; 
        }
        @keyframes fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes fade-in-up { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.6s ease-out forwards; }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out both; }
        @keyframes loader-bar { 0%, 80%, 100% { transform: scaleY(0.4); opacity: 0.5; } 40% { transform: scaleY(1); opacity: 1; } }
        .animate-loader-bar { animation: loader-bar 1.2s infinite ease-in-out; }
        .generate-button {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        .generate-button:not(:disabled):hover {
            box-shadow: 0 0 20px 5px rgba(59, 130, 246, 0.3);
        }
        .generate-button:not(:disabled):active {
            transform: scale(0.98);
            box-shadow: 0 0 5px 2px rgba(59, 130, 246, 0.2);
        }
        .accordion-content, #subgenre-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .subgenre-button {
            background-color: rgba(31, 41, 55, 0.5);
            border: 1px solid rgb(75 85 99 / 0.8);
        }
        .subgenre-button.selected {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #eff6ff;
        }
    </style>
</head>
<body class="text-white">
    <canvas id="particle-canvas" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>
    
    <main class="max-w-6xl mx-auto p-4 md:p-8 relative z-10">
        <header class="text-center my-8 md:my-12 animate-fade-in">
            <h1 class="text-4xl md:text-5xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">Serum Preset Co-Pilot</h1>
            <p class="text-lg text-gray-400 mt-2">Guide the AI to craft your perfect sound.</p>
        </header>

        <section class="animate-fade-in" style="animation-delay: 0.2s;">
            <div class="text-center mb-4"><span class="text-lg font-semibold text-gray-300">1. Select a Genre</span></div>
            <div id="genre-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-10 gap-3 md:gap-4 mb-4">
                <!-- Genre cards will be injected here by JavaScript -->
            </div>
            <div id="subgenre-container" class="w-full">
                <!-- Sub-genres will be injected here -->
            </div>
        </section>
        
        <section class="glass-card p-6 my-10 animate-fade-in" style="animation-delay: 0.4s;">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label for="type-select" class="block text-sm font-bold text-gray-300 mb-2 text-center md:text-left">2. Choose a Type</label>
                    <select id="type-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                        <!-- Type options will be injected here -->
                    </select>
                </div>
                <div>
                    <label for="mood-select" class="block text-sm font-bold text-gray-300 mb-2 text-center md:text-left">3. Set the Mood</label>
                    <select id="mood-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                        <!-- Mood options will be injected here -->
                    </select>
                </div>
            </div>
            <div class="mb-6">
                <label for="inspired-by-input" class="block text-sm font-bold text-gray-300 mb-2 text-center md:text-left">4. Inspired By (Optional)</label>
                <input type="text" id="inspired-by-input" placeholder="e.g., a Hans Zimmer pad, Flume-style chords" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
            </div>
            <div>
                <button id="generate-button" class="generate-button w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold py-2.5 px-6 rounded-md shadow-lg disabled:bg-gray-500 disabled:from-gray-500 disabled:cursor-not-allowed flex items-center justify-center">
                    5. Generate Preset
                </button>
            </div>
        </section>

        <section id="results-section" class="min-h-[24rem]">
            <!-- Results will be injected here -->
        </section>
    </main>

    <script type="module">
        // --- DATA AND STATE MANAGEMENT ---
        const state = {
            selections: { genre: null, subgenre: null, type: 'Lead', mood: 'Uplifting', inspiredBy: '' },
            loading: false,
            preset: null,
            presetTitle: '',
            error: null,
            activeGradientSet: 'a', // 'a' or 'b'
        };

        const genres = [
            { name: 'House', icon: 'üè†', subgenres: ['Tech House', 'Deep House', 'Progressive House', 'Afro House', 'Future House'] },
            { name: 'Techno', icon: 'üéõÔ∏è', subgenres: ['Melodic Techno', 'Hard Techno', 'Minimal Techno', 'Industrial Techno'] },
            { name: 'Trance', icon: 'üåÄ', subgenres: ['Uplifting Trance', 'Psytrance', 'Progressive Trance', 'Vocal Trance'] },
            { name: 'Dubstep', icon: 'ü§ñ', subgenres: ['Riddim', 'Melodic Dubstep', 'Tearout', 'Future Riddim'] },
            { name: 'Future Bass', icon: 'üé∂' },
            { name: 'Lo-fi', icon: '‚òï' },
            { name: 'Trap', icon: '‚õìÔ∏è', subgenres: ['Hardwave', 'Hybrid Trap', 'Cloud Rap'] },
            { name: 'Drill', icon: 'üî™', subgenres: ['UK Drill', 'NY Drill', 'Jersey Drill'] },
            { name: 'Phonk', icon: 'üíÄ', subgenres: ['Drift Phonk', 'Memphis Phonk', 'Phonk Wave'] },
            { name: 'Synthwave', icon: 'üåÖ', subgenres: ['Darksynth', 'Outrun', 'Retrowave'] },
            { name: 'Drum & Bass', icon: 'ü•Å', subgenres: ['Neurofunk', 'Liquid D&B', 'Jump-Up', 'Dancefloor D&B'] },
            { name: 'Hip Hop', icon: 'üé§' },
            { name: 'Pop', icon: 'üåü', subgenres: ['Synth-Pop', 'Hyperpop', 'K-Pop', 'Dance-Pop'] },
            { name: 'R&B', icon: 'üíñ', subgenres: ['Contemporary R&B', 'Alternative R&B'] },
            { name: 'Soul', icon: 'üé∑', subgenres: ['Neo-Soul', 'Modern Soul', 'Psychedelic Soul'] },
            { name: 'Indie', icon: 'üé∏', subgenres: ['Indie Pop', 'Indie Rock', 'Dream Pop'] },
            { name: 'Folk', icon: 'ü™ï', subgenres: ['Indie Folk', 'Folk-Pop', 'Traditional Folk'] },
            { name: 'Cinematic', icon: 'üé¨' },
            { name: 'Ambient', icon: 'üåå' },
            { name: 'Hyperpop', icon: '‚ú®' },
        ];
        const presetTypes = ['Lead', 'Bass', 'Pad', 'Keys', 'Pluck', 'Arp', 'FX', 'Synth', 'Strings', 'Brass', 'Bell', 'Piano', 'Woodwind', 'Chord'];
        const presetMoods = ['Aggressive', 'Ambient', 'Chill', 'Cinematic', 'Club', 'Dance', 'Dark', 'Dreamy', 'Dynamic', 'Energetic', 'Experimental', 'Funky', 'Groovy', 'Happy', 'Intense', 'Mellow', 'Nostalgic', 'Party', 'Sad', 'Smooth', 'Soothing', 'Uplifting'];
        
        const moodThemes = {
            'Default': ['#0d1117', '#161b22'], 
            'Uplifting': ['#0d1117', '#1a2a45'], 
            'Happy': ['#111827', '#4a3a1f'], 
            'Party': ['#111827', '#4d1a3d'], 
            'Club': ['#0d1117', '#3d1a4d'], 
            'Sad': ['#111827', '#1f2937'], 
            'Mellow': ['#111827', '#1e3a3a'], 
            'Chill': ['#0d1117', '#1a3a3a'], 
            'Dark': ['#0d1117', '#221616'], 
            'Aggressive': ['#111827', '#451a1a'], 
            'Nostalgic': ['#111827', '#3a3a1f'], 
            'Experimental': ['#111827', '#3a1f4a'], 
            'Cinematic': ['#0d1117', '#1f2937'], 
            'Dance': ['#111827', '#4d1a4d'], 
            'Groovy': ['#111827', '#4a3a1f'],
            'Ambient': ['#0d1117', '#1a3a3a'],
            'Dynamic': ['#0d1117', '#3d1a4d'],
            'Energetic': ['#111827', '#4a3a1f'],
            'Funky': ['#111827', '#4d1a3d'],
            'Smooth': ['#111827', '#1f2937'],
            'Soothing': ['#111827', '#1e3a3a'],
            'Dreamy': ['#111827', '#3a1f4a'],
            'Intense': ['#111827', '#451a1a'],
        };

        const serumWavetables = {
            'Analog': ['Acid', 'Analog_BD_Sin', 'Basic Mg', 'Basic Mini', 'Basic Shapes', 'Basic_Cjw', 'Basic_McB', 'Basic_Mdc', 'Basic_Wrd', 'BS2 - Acid', 'BS2 - Filthy', 'BS2 - Subby Saw', 'BSOD_Square', 'DS Saw and Tri', 'Jno', 'MATRIXY C64', 'MB Saw', 'MB Triangle (Metal)', 'Mellow But Instable', 'MiniBass', 'MsAw', 'MsPw', 'PWM C64', 'PWM DS', 'PWM Genji', 'PWM Inception', 'PWM Juno', 'PWM LPF', 'PWM Maths 2', 'PWM Maths', 'PWM MedicineHat', 'PWM MG', 'PWM Mini', 'PWM Reso', 'PWM Restricted', 'PWM Trench', 'PWM_Mdc', 'SawRounded', '808 Harms', '808 Kick', 'AT Alter', 'AT Analog Four', 'AT ARP 2600', 'AT DFAM', 'AT Dixie', 'AT Easel Mod Osc', 'AT Entity', 'AT Furth Mood Symmetry', 'AT Furthrrrr', 'AT Harmonic Oscillator Mixer', 'AT Juno 106', 'AT Loquelic iteritas PM', 'AT Loquelic lteritas SS', 'AT Matriarch', 'AT Model 10', 'AT Model D', 'AT Mopho x4', 'AT Mother 32', 'AT Perfourmer MKI', 'AT Plaits Modal', 'AT Plaits Wavetable', 'AT Promars', 'AT Spectrum', 'AT VCO', 'DM-OSCAR', 'DM FMOD 01', 'DM FMOD 02', 'HW -OsC', 'Jungle 808', 'Mello', 'Modular18', 'MWoog', 'No Fund Tri Saw Sq', 'Perfect 808 Sub Shapes', 'PolySaw', 'Saw Alice', 'Saw Drift 303'],
            'Digital': ['Anti-Stasis', 'bipole_harmonic', 'BottleBlow', 'CrushWub', 'Debussy', 'DirtySaw', 'Dist 8bit Fwap', 'Dist Bass Dropper', 'Dist C2', 'Dist d00t', 'Dist Fwapper SQ', 'Dist Sub Dskperc', 'Dist WaTech', 'Dull_toy', 'Ethos', 'Evol Longreece', 'Evol Sweep', 'Evolution', 'FFT_Add_2nds', 'FFT_Add_3rds', 'FFT_Add_4ths', 'FFT_Animal 1', 'FFT_SQUEAL', 'FMFM', 'FM_Freak', 'FM_Splat', 'Gritty', 'GS-xello', 'Harmonic Morph', 'Harmonic Subtle', 'HarmonicSeries', 'Hoo', 'Hypa', 'ICanHaskick', 'Kream', 'Mario', 'Misfits', 'PerfectSQSteps', 'Prime', 'PWM Electro', 'PWM Weird', 'Razor', 'Reese', 'Ring', 'Scream', 'Shrats', 'Sludgecrank', 'SSQ', 'SubBass_1', 'Tigra', 'VintageSynth', 'Voxu', 'Waveterminal', 'Weow', 'Wraith', 'Yoy64', '4 Partials All Combos', '6 Partials All Combos', 'Additive Talk', 'AM Sine Harmonics', 'Bark', 'Basic OPL', 'Bass Pluck', 'Belladonna', 'Big Slab', 'Bitspeek 2 Seperate', 'Braids Bell Pluck', 'Brass Stab', 'C Morph', 'Chord', 'Dinosaurs', 'DisHarm', 'DX Brass 2', 'DX Hard Attack', 'Dying Saw', 'Dying Sine', 'Dying Square', 'Electric Noise', 'FB', 'Fish flips and morphs into Swordfish', 'FM Careful Triangle', 'FM Dangerous Saw 2', 'FM Dangerous Saw', 'FM Dirty Square', 'FM Piano', 'FM Sine Hell', 'Generative Waves', 'GS Jharp', 'Gtr Harmnx', 'Hand Drawn EBass', 'Hardware Waveforms', 'Harm Octave', 'Harmonic Series Smooth', 'Harmonic Squares', 'Harmonize the q', 'Harsh Harm', 'HyperSqueak', 'IcanGPT', 'JF Flute', 'Lately', 'Memory Organ', 'Morpheus', 'Mr Bruce Lee', 'No Fundamental Saw', 'Only H1', 'Only H2', 'Ooomph', 'Organ Cluster', 'Piano', 'Pieceful', 'Porta Waves', 'Random Partials', 'RCM Bass 1', 'RCM Bass 2', 'Renegade', 'Rich Pluck', 'RMrk1 Key Up', 'RMrK1 Tine', 'RMrk1', 'Shep. Oct+Fifths', 'Shep, Octaves', 'Sine SuperChirp', 'Sine with Benefits', 'Softest Growl', 'Squibble', 'Talking Vox', 'Toucan', 'TrickTreat', 'Tubular', 'Vibing', 'Vocal Hum', 'Voice Simple', 'Voxy'],
            'Spectral': ['AlienSpectral', 'Bowed Metal', 'Trilobyte 1', 'Trilobyte 2', 'Trilobyte 3', 'Creeper', 'Electric Guitar', 'Gremlin', 'Grimace', 'Light Metal 1', 'Monster 1', 'Monster 2', 'Monster 3', 'Monster A', 'Monster 5', 'Monster 6', 'Monster 7', 'Monster 8', 'Monster 9', 'Oddpass', 'Phase Werb', 'Reesey Mess 1', 'Reesey Mess 2', 'Reesey Mess 3', 'Reesey Mess 4', 'Reesey Mess 5', 'Scout', 'Solid Phase 1', 'Solid Phase 2', 'Squelchy 1', 'Squelchy 2', 'Squelchy 3', 'Squelchy FM 1', 'Squelchy FM 2', 'Thin Thick'],
            'Vowel': ['Allophones', 'DudaChoir', 'E_Yeah', 'Fred Like Bass', 'ML Addifunk', 'Native Curse', 'OOH YAH 00', 'LLI', 'Retro Speaking', 'SAM SERUM', 'SAM Speaks', 'WahWah']
        };
        const serumNoises = {
            'Analog': ['AlphaNz', 'ARP circult', 'ARP pink', 'ARP white', 'BrightWhite', 'J60', 'J8', 'J106 Chorus', 'J106 HP', 'J106 HP_Cho', 'J106', 'Micrkrg Noise', 'OrganNolise', 'SH1 Noise', 'SID drone', 'SID noise', 'SID whine'],
            'Organics': ['AC hum1', 'AC hum2', 'Air Can 1', 'Air Can 2', 'Air Can 3', 'Air Can 4', 'Air Can 5', 'CymLoop', 'CymMicBleed', 'H-Breath', 'Paper Bag', 'S-Sound', 'Shush 1', 'Shush 2', 'Squeeky', 'WindChimes'],
            'S2 Noises': ['808 Transient', 'Arctic Visit', 'Blip', 'Cicadas', 'Crackle', 'Egtr Mute', 'Egtr Neck Down', 'Egtr Neck Up', 'Fizz', 'FretNoise A', 'FretNoise B', 'FretNoise C', 'HP12 Pink Noise (Mono)', 'HP12 Pink Noise (Stereo)', 'HP12 White Noise (Stereo)', 'Keys and Ball', 'Pebbles in Tube', 'Radio Glitch', 'Rain 100 Hgh', 'Rising Wind', 'SaW', 'Screws in Bowl', 'Sine Wave C', 'Stretched Vlnyl', 'Vinyl Crackle', 'Whif'],
            'SOR': ['Analog Flow', 'Atmos 05', 'Atmos 07', 'Atmos 11', 'Atmos 14', 'Atmos 18', 'Atmos 20', 'Atmos 44', 'Atmos 45', 'Atmos 47', 'Atmos 52', 'Bonecrusher', 'Dark Phuture', 'Electric Bubbles', 'Electricity', 'Elysium', 'FX5', 'Horns Of Fear', 'Horrorwind', 'Metalmaster', 'Place f Fear', 'Polar 1', 'Polar 2', 'Prophecy', 'Rising', 'Strange Flow', 'Waterworld'],
            'Color': ['White', 'Pink', 'Brown', 'Geiger'],
            'Acoustic': ['Breathy Pianoish', 'EPiano Chord', 'Piano High Long Tail', 'Piano Middle C', '44', 'Piano', 'Sympathy Piano C4', 'Aztec Pipe', 'Betty', 'Flute Delay', 'Flute Fula Long', 'Flute Fula', 'Flute Long Stab', 'Flute Long Vibrato', 'Flute Rainforest', 'Flute Staccato', 'Flute Virtual', 'Flute Warm', 'Pan Flute', 'Savanna', 'Brass WallLow', 'Horn Stab Emin', 'Trombone Alt', 'II', 'stc A#1', 'GG3', 'Trombone short', 'Trombone short stc', 'Trombone', 'Tuba short stc G1', 'Celli ColLegno F#1', 'Celli Short G#2', 'Cello Finger Gliss UpC2', 'Doubled Tension', 'Doubled Vibrato', 'Erhu', 'Horsehead Fiddle', 'Morin Khuur Sustained', 'Strings Crystal Joy', 'Strings Heady', 'Strings Oblinas', 'Unhappy Chatty Cello', 'Upright Bass rco Long', 'Upright Bass Arco Short', 'ViolinsHalf Harm Glissh E5']
        };
        
        const categorizedAcousticSamples = {
            'Piano': ['Breathy Pianoish', 'EPiano Chord', 'Piano High Long Tail', 'Piano Middle C', '44', 'Piano', 'Sympathy Piano C4'],
            'Woodwind': ['Aztec Pipe', 'Betty', 'Flute Delay', 'Flute Fula Long', 'Flute Fula', 'Flute Long Stab', 'Flute Long Vibrato', 'Flute Rainforest', 'Flute Staccato', 'Flute Virtual', 'Flute Warm', 'Pan Flute', 'Savanna'],
            'Brass': ['Brass WallLow', 'Horn Stab Emin', 'Trombone Alt', 'II', 'stc A#1', 'GG3', 'Trombone short', 'Trombone short stc', 'Trombone', 'Tuba short stc G1'],
            'Strings': ['Celli ColLegno F#1', 'Celli Short G#2', 'Cello Finger Gliss UpC2', 'Doubled Tension', 'Doubled Vibrato', 'Erhu', 'Horsehead Fiddle', 'Morin Khuur Sustained', 'Strings Crystal Joy', 'Strings Heady', 'Strings Oblinas', 'Unhappy Chatty Cello', 'Upright Bass rco Long', 'Upright Bass Arco Short', 'ViolinsHalf Harm Glissh E5']
        };

        const allValidWavetables = Object.entries(serumWavetables).flatMap(([category, tables]) => tables.map(table => `${category} > ${table}`));
        const allValidNoises = Object.entries(serumNoises).flatMap(([category, noises]) => noises.map(noise => `${category} > ${noise}`));

        // --- DOM ELEMENTS ---
        const genreGrid = document.getElementById('genre-grid');
        const subgenreContainer = document.getElementById('subgenre-container');
        const typeSelect = document.getElementById('type-select');
        const moodSelect = document.getElementById('mood-select');
        const inspiredByInput = document.getElementById('inspired-by-input');
        const generateButton = document.getElementById('generate-button');
        const resultsSection = document.getElementById('results-section');

        // --- UI RENDERING FUNCTIONS ---
        function renderInitialUI() {
            genreGrid.innerHTML = genres.map(g => `
                <button data-genre="${g.name}" class="group relative flex flex-col items-center justify-center p-4 rounded-2xl transition-all duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-400">
                    <div class="absolute inset-0 rounded-2xl bg-gray-800/60 group-hover:bg-gray-700/80 transition-all duration-300"></div>
                    <div class="absolute inset-0 rounded-2xl border border-gray-700 group-hover:border-gray-600 transition-all duration-300"></div>
                    <div class="absolute inset-0 rounded-2xl shadow-none group-hover:shadow-[0_0_15px_rgba(59,130,246,0.2)] transition-all duration-500"></div>
                    <div class="relative z-10 flex flex-col items-center justify-center space-y-3">
                        <span class="text-3xl">${g.icon}</span>
                        <span class="font-semibold text-sm text-center text-gray-300 group-hover:text-white transition-colors duration-300">${g.name}</span>
                    </div>
                </button>
            `).join('');

            typeSelect.innerHTML = presetTypes.map(t => `<option value="${t}">${t}</option>`).join('');
            typeSelect.value = state.selections.type;

            moodSelect.innerHTML = presetMoods.map(m => `<option value="${m}">${m}</option>`).join('');
            moodSelect.value = state.selections.mood;
            
            updateResultsUI();
        }

        function renderSubgenres(genreName) {
            const genre = genres.find(g => g.name === genreName);
            if (genre && genre.subgenres) {
                const subgenreHTML = `
                    <div class="text-center mb-3 text-gray-400 animate-fade-in">Sub-Genre (Optional)</div>
                    <div class="flex flex-wrap justify-center gap-3 animate-fade-in">
                        ${genre.subgenres.map(sg => `
                            <button data-subgenre="${sg}" class="subgenre-button text-gray-300 font-semibold py-2 px-4 rounded-full transition-colors duration-200 hover:bg-gray-700/70 hover:border-gray-500">
                                ${sg}
                            </button>
                        `).join('')}
                    </div>
                `;
                subgenreContainer.innerHTML = subgenreHTML;
                subgenreContainer.style.maxHeight = subgenreContainer.scrollHeight + "px";
                subgenreContainer.classList.add('mt-6');
            } else {
                subgenreContainer.style.maxHeight = '0';
                subgenreContainer.classList.remove('mt-6');
                subgenreContainer.innerHTML = '';
            }
        }

        function updateResultsUI() {
            if (state.loading) {
                resultsSection.innerHTML = `<div class="flex justify-center items-center p-8"><div class="w-12 h-12"><div class="animate-pulse flex space-x-1"><div class="w-3 h-12 bg-blue-400 rounded-full animate-loader-bar" style="animation-delay: 0s"></div><div class="w-3 h-12 bg-blue-400 rounded-full animate-loader-bar" style="animation-delay: 0.1s"></div><div class="w-3 h-12 bg-blue-400 rounded-full animate-loader-bar" style="animation-delay: 0.2s"></div></div></div></div>`;
            } else if (state.error) {
                resultsSection.innerHTML = `<div class="glass-card p-4 text-center text-red-400">${state.error}</div>`;
            } else if (state.preset) {
                const sections = state.preset.split('###').filter(section => {
                    const trimmedSection = section.trim();
                    return trimmedSection !== '' && !trimmedSection.toUpperCase().startsWith('PRESET NAME');
                });
                
                const presetHTML = sections.map((section, index) => {
                    const lines = section.trim().split('\n');
                    const title = lines.shift().trim().replace(/#/g, '');
                    const content = lines.filter(line => line.trim() !== '' && line.includes(':'));
                    if (content.length === 0) return '';
                    
                    const listItems = content.map(line => {
                        const [key, ...valueParts] = line.split(':');
                        return `<li class="text-gray-300 text-sm p-2 rounded-md"><span><strong class="font-semibold text-gray-200">${key}:</strong> ${valueParts.join(':').trim()}</span></li>`;
                    }).join('');

                    return `<div class="glass-card mb-4 animate-fade-in-up" style="animation-delay: ${index * 50}ms"><button class="accordion-toggle w-full flex justify-between items-center p-4 text-left"><h3 class="text-lg font-bold text-blue-300">${title}</h3><svg class="w-6 h-6 text-gray-400 transform transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" /></svg></button><div class="accordion-content px-4 pb-4"><ul class="space-y-2 border-t border-gray-700/50 pt-3">${listItems}</ul></div></div>`;
                }).join('');

                resultsSection.innerHTML = `<div class="animate-fade-in"><h2 class="text-2xl font-bold text-center mb-6 text-white"><span class="text-blue-400">${state.presetTitle}</span></h2>${presetHTML}</div>`;
            } else {
                resultsSection.innerHTML = `<div class="flex items-center justify-center h-full min-h-[24rem] animate-fade-in" style="animation-delay: 0.6s;"><div class="text-center glass-card p-8"><h3 class="text-lg font-semibold text-gray-200">Follow the steps above to begin</h3><p class="text-gray-400 mt-1">Your unique preset guide will appear here.</p></div></div>`;
            }
            attachAccordionListeners();
        }
        
        // --- EVENT HANDLERS ---
        function handleGenreSelect(e) {
            const button = e.target.closest('button[data-genre]');
            if (!button) return;
            
            const genreName = button.dataset.genre;
            state.selections.genre = genreName;
            state.selections.subgenre = null;

            document.querySelectorAll('#genre-grid button').forEach(btn => {
                const container = btn.children[0];
                const border = btn.children[1];
                const shadow = btn.children[2];
                if (btn.dataset.genre === genreName) {
                    btn.classList.add('scale-105');
                    container.classList.add('bg-blue-500/20', 'group-hover:bg-blue-500/30');
                    container.classList.remove('bg-gray-800/60', 'group-hover:bg-gray-700/80');
                    border.classList.add('border-blue-400');
                    border.classList.remove('border-gray-700', 'group-hover:border-gray-600');
                    shadow.classList.add('shadow-[0_0_20px_rgba(59,130,246,0.5)]');
                } else {
                    btn.classList.remove('scale-105');
                    container.classList.remove('bg-blue-500/20', 'group-hover:bg-blue-500/30');
                    container.classList.add('bg-gray-800/60', 'group-hover:bg-gray-700/80');
                    border.classList.remove('border-blue-400');
                    border.classList.add('border-gray-700', 'group-hover:border-gray-600');
                    shadow.classList.remove('shadow-[0_0_20px_rgba(59,130,246,0.5)]');
                }
            });
            
            renderSubgenres(genreName);
            generateButton.disabled = false;
        }
        
        function handleSubgenreSelect(e) {
            const button = e.target.closest('button[data-subgenre]');
            if(!button) return;

            const subgenreName = button.dataset.subgenre;
            
            if (button.classList.contains('selected')) {
                button.classList.remove('selected');
                state.selections.subgenre = null;
            } else {
                document.querySelectorAll('#subgenre-container button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                button.classList.add('selected');
                state.selections.subgenre = subgenreName;
            }
        }

        function attachAccordionListeners() {
            document.querySelectorAll('.accordion-toggle').forEach(button => {
                // Set initial state for new content
                const content = button.nextElementSibling;
                const icon = button.querySelector('svg');
                if (content.style.maxHeight) {
                    // This accordion is already open, do nothing
                } else {
                     icon.style.transform = '';
                }

                button.onclick = () => {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.style.transform = '';
                    } else {
                        // Close all other accordions
                        document.querySelectorAll('.accordion-content').forEach(acc => {
                            acc.style.maxHeight = null;
                            acc.previousElementSibling.querySelector('svg').style.transform = '';
                        });
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.style.transform = 'rotate(180deg)';
                    }
                };
            });
        }

        // --- API & LOGIC ---
        const getCreativePrompt = (selections) => {
            const { genre, subgenre, type, mood, inspiredBy } = selections;
            const fullGenre = subgenre ? `${subgenre}` : genre;

            const genreKnowledge = {
                'Tech House': `Timbres: Focus on tight, punchy sounds. Use basic analog shapes (squares, saws) or simple digital tables. FM synthesis is common for percussive bass sounds. Envelopes: Very short decay, zero sustain (plucks). Filter: Low-pass filters (MG Low 24) with short decay envelopes are key. AVOID: Long releases, complex evolving pads.`,
                'Deep House': `Timbres: Smooth, warm sounds. Analog wavetables like Juno and Basic Mini are excellent. Electric piano samples in the Noise OSC work well. Envelopes: Slightly longer releases than Tech House for pads and keys. Filter: Gentle low-pass filtering (MG Low 12 or 18) to create a warm, submerged feel. AVOID: Harsh distortion, aggressive wavetables.`,
                'Progressive House': `Timbres: Supersaw leads (use high unison on saw waves), lush pads, and arpeggiated plucks. Analog wavetables are key. Envelopes: Long attack and release for pads, short plucky envelopes for arps/basses. Filter: Sweeping low-pass filters (24dB) are a staple of the genre. AVOID: Dry, sterile sounds.`,
                'Afro House': `Timbres: Organic and acoustic sounds. Use Noise OSC with percussive samples. Plucks can be made from digital or analog tables. Mallet/bell-like sounds are common. Envelopes: Short and percussive for most elements. Filter: Used to shape sounds, often with a bit of resonance to add character. AVOID: Overly synthetic or aggressive textures.`,
                'Future House': `Timbres: Metallic, bouncy basslines are key, often made with FM synthesis from basic shapes. Bright, plucky leads. Envelopes: Very tight, short envelopes for basses and leads. Filter: Low-pass filters with envelope modulation to create the characteristic 'wobble' or pluck. AVOID: 'Dirty' or 'gritty' distortion.`,
                'Melodic Techno': `Timbres: Rich, evolving arps and pads. Analog-style wavetables (Juno, SawRounded) and some digital textures. Supersaws are common. Envelopes: Long, evolving envelopes for pads and leads. Short, snappy envelopes for arps. Filter: Slow, sweeping low-pass filters create tension and release. Consider Acid or German LP filters. AVOID: Abrasive high-end, overly complex rhythms.`,
                'Hard Techno': `Timbres: Highly distorted and aggressive sounds. Digital and spectral wavetables with distortion are common. Noise oscillator for industrial texture. Filter: Use aggressive filters like Scream LP, Dist.Comb, or highly resonant standard filters. AVOID: 'Pretty' or melodic elements.`,
                'Minimal Techno': `Timbres: Focus on simple, clean tones. Sine waves, triangles, and basic digital tables. Percussive clicks and blips from the Noise OSC. Filter: Band-pass and high-pass filters are used frequently to thin out sounds and create rhythmic interplay. AVOID: Lush pads, complex melodies, heavy layering.`,
                'Industrial Techno': `Timbres: Metallic, noisy, and dissonant. Use spectral and digital wavetables, especially ones that sound like machines or noise. Remap modes can be powerful here. Filter: Comb filters, Ring Mod, and resonant high-pass filters to create harsh textures. AVOID: Conventional musical harmony, smooth sounds.`,
                'Uplifting Trance': `Timbres: The supersaw lead is king. Use 7+ unison voices on a saw wave, detuned significantly. Plucks are often simple saw/square waves. Pads are lush and analog-sounding. Filter: Wide open low-pass filters on leads. Sweeping filters for transitions. MG Low 24 is a classic choice. AVOID: Under-saturated or dry sounds.`,
                'Psytrance': `Timbres: Complex, futuristic sounds. FM, phase modulation, and spectral wavetables are heavily used. Leads are often sharp and acidic. Basses are rolling and typically off-beat. Filter: Band-pass and formant filters with fast LFO modulation are key to the psychedelic sound. Phs and Flg filters are excellent. AVOID: Simple, static sounds.`,
                'Progressive Trance': `Timbres: A blend of Progressive House and Trance. Deeper, warmer sounds than Uplifting Trance. Less reliance on the main supersaw lead, more on plucks and atmospheric pads. Filter: More subtle filter work, focusing on gradual evolution. MG Low 18 or 24 are good choices. AVOID: Overly aggressive or fast-paced elements.`,
                'Vocal Trance': `Timbres: The focus is on supporting a vocalist. Pads must be lush and warm, leads should be melodic but not overpowering. Use classic analog wavetables. Filter: Used to gently shape sounds and ensure they don't clash with the vocal frequency range. AVOID: Sounds that are too busy or aggressive.`,
                'Riddim': `Timbres: Simple wavetables (often sine/triangle) subjected to extreme processing. The sound comes from the FX and modulation, not the source. Filter: Comb filters and All-Pass filters (phaser) modulated by a square LFO create the characteristic sound. AVOID: Complex melodic ideas, sustained sounds.`,
                'Melodic Dubstep': `Timbres: Similar to Future Bass. Big, emotional supersaw chords and leads. Lush, atmospheric pads. Sub-bass is crucial. Filter: Used to create powerful sweeps leading into drops. Classic MG Low 24 is perfect. AVOID: Atonal or overly aggressive bass design.`,
                'Tearout': `Timbres: Extremely aggressive, metallic, and noisy. Spectral wavetables (e.g., Scream, Growl) and heavy FM synthesis. Dissonance is key. Filter: Used as a sound design tool with heavy resonance and fast modulation to create screeching sounds. Scream LP/BP and Dist.Comb filters are ideal. AVOID: Subtlety, traditional harmony.`,
                'Future Riddim': `Timbres: A fusion of melodic and heavy elements. Often uses colorful, bell-like or chordal sounds as the basis for the rhythmic chopping. Digital wavetables are common. Filter: Formant and comb filters to add vocal-like character. A mix of clean and aggressive filters. AVOID: Simple on/off patterns.`,
                'Future Bass': `Timbres: Bright, detuned supersaw chords are a staple. Sine or triangle wave sub-bass. Pitched vocal chops in the Noise OSC. Arps are common. Filter: Low-pass filter on chords, modulated by an LFO synced to the track's sidechain. AVOID: Aggressive distortion.`,
                'Lo-fi': `Timbres: Imperfection is key. Use analog wavetables with slight pitch drift (via LFO). Use Noise OSC with vinyl crackle or tape hiss samples. Electric piano samples are great. Filter: Low-pass filter (Low 6 or 12) to roll off high frequencies is essential for the 'underwater' sound. AVOID: Clean, bright, digital sounds.`,
                'Hardwave': `Timbres: A sub-genre of Trap. Ethereal, atmospheric pads and leads, often using detuned supersaws, layered with hard-hitting Trap drums. Reese basses are very common. Filter: Gentle, sweeping filters (MG Low 18/24) to add movement. AVOID: Dry, simple sounds.`,
                'Hybrid Trap': `Timbres: A mix of Trap and Dubstep. Expect aggressive, growling basses (like Dubstep) paired with Trap drum patterns and 808s. Filter: Used for both aggressive bass modulation (e.g., Scream filters) and melodic sweeps. AVOID: Sticking to just one genre's conventions.`,
                'Cloud Rap': `Timbres: Dreamy, hazy, and atmospheric. Use pads with long attack/release. Simple, clean wavetables like sines and triangles, washed in effects. Filter: Heavy low-pass filtering to create a muffled, distant feel. AVOID: Sharp, punchy, or aggressive sounds.`,
                'UK Drill': `Timbres: Dark and ominous sounds are key. Simple wavetables (saws, squares) for basses. Pads should be eerie. Sliding 808-style sub-basses are central. Filter: Low-pass filters to keep sounds dark and moody. AVOID: Bright, happy sounds; complex melodies.`,
                'NY Drill': `Timbres: Often more sample-based and gritty than UK Drill. Noisy, distorted basses. Still features sliding 808s. Filter: Used to add grit and character, sometimes with a bit of drive. AVOID: Clean, polished sounds.`,
                'Jersey Drill': `Timbres: More upbeat and dance-oriented. Features bouncy, energetic basslines, often using a "kick" sample in the Noise OSC layered with a sub. Filter: Used to make sounds tight and focused. AVOID: Long, sustained sounds.`,
                'Drift Phonk': `Timbres: Heavily distorted and saturated basslines with a prominent cowbell melody. The bass often uses saw waves with heavy distortion. Filter: Often used to add resonance and grit to the bass. AVOID: Clean sounds, complex melodies beyond the cowbell.`,
                'Synthwave': `Timbres: Nostalgic 80s sounds. Analog wavetables are essential (Juno, Jupiter, Saw, Square). Brass stabs, plucky basses, and warm pads. Filter: Low-pass filters with a bit of resonance are key to the vintage sound. MG Low 12 or 18 are perfect. AVOID: Modern, digital, or aggressive wavetables.`,
                'Darksynth': `Timbres: A darker, more aggressive take on Synthwave. Uses more distortion and sometimes more complex, digital wavetables alongside the classic analog ones. Filter: Used more aggressively, with more resonance. Consider the German LP or Acid Ladder filters. AVOID: Overly bright or happy sounds.`,
                'Neurofunk': `Timbres: The genre is defined by complex, technically intricate basslines ('reese' basses and 'growls'). Heavy use of FM, AM, and Ring Modulation. Spectral and Digital wavetables are essential. Filter: This is critical. Comb filters, Allpasses, Phasers, and Band-pass filters are modulated at high speed to create the talking, robotic bass sounds. AVOID: Simple, static bass sounds.`,
                'Liquid D&B': `Timbres: Smooth, soulful, and melodic. Deep, rolling sub-basses (often just a simple sine wave). Rhodes-style keys, lush pads, and gentle leads. Filter: Gentle low-pass filtering (MG Low 12 or 18) to keep sounds warm and deep. AVOID: Aggressive or distorted sounds.`,
                'Jump-Up': `Timbres: Simple, energetic, and often goofy bass sounds. The classic sound is a 'wobble' bass made with a simple wavetable and an LFO modulating the filter cutoff. Filter: A low-pass filter (MG Low 24) modulated by a sine or triangle LFO is the core of the sound. AVOID: Complex, evolving sounds.`,
                'Pop': `Timbres: Clean, bright, and polished. Modern pop uses a wide range of sounds, but they are always high-quality. Simple analog shapes, clean digital tables, and sampled instruments are all common. Filter: Used to ensure sounds fit perfectly in a dense mix. High-pass filtering to remove unnecessary low-end is crucial. AVOID: Overly experimental or lo-fi sounds (unless that's the specific sub-genre).`,
                'R&B': `Timbres: Smooth, lush, and modern. Warm pads, deep basses (often sine/triangle based), and soft, breathy leads. Electric piano sounds are a staple. Filter: Gentle low-pass filtering to maintain a warm, intimate vibe. AVOID: Harsh or aggressive sounds.`,
                'Soul': `Timbres: Rooted in classic analog sounds. Warm basses, organ-like keys, and brass sounds. Use analog wavetables or acoustic samples. Filter: Used to emulate the warm character of vintage equipment. The French LP or German LP can be great here. AVOID: Overly digital or modern-sounding textures.`,
                'Indie': `Timbres: Often characterized by a slightly 'lo-fi' or 'garage' aesthetic. Detuned analog wavetables, slightly distorted guitars (use noise osc samples), and unique, quirky sounds. Filter: Used to create character, not for clean sweeps. A little resonance can add a nice edge. AVOID: Overly polished, perfect-sounding presets (unless making Indie Pop).`,
                'Folk': `Timbres: Acoustic and natural sounds are paramount. Use the acoustic samples in the Noise OSC as the primary sound source. Layer with simple analog waves for warmth. Filter: Used mainly for EQing - cutting low-end mud or harsh highs with Low EQ or High EQ filters. AVOID: Obvious synthesis, heavy modulation, synthetic effects.`,
                'Cinematic': `Timbres: Large, epic, and evolving. Orchestral samples (strings, brass) are key. Layer them with massive synth pads (supersaws, complex digital tables). Filter: Slow, epic filter sweeps are a staple. AVOID: Small, dry, or simple sounds.`,
                'Ambient': `Timbres: Texture and atmosphere are everything. Use any wavetable, but process it heavily. Evolving pads, granular textures (use Noise OSC with unusual samples), and gentle drones. Filter: Very slow LFO modulation on the filter cutoff to create constant, subtle movement. The Reverb filter can be a powerful tool here. AVOID: Short, percussive sounds; anything that feels rushed.`,
                'Hyperpop': `Timbres: Extreme, chaotic, and digital. Aggressive digital wavetables, heavy FM, and bit-crushed sounds. Supersaws are pitched up and heavily processed. Filter: Used for aggressive, fast modulation. Formant and comb filters are common. The Scream LP is a great choice. AVOID: Natural, subtle, or clean sounds.`,
            };

            const serumFxKnowledge = `
                **Serum FX Knowledge Base (Hyper-Specific):**
                - **Distortion:** Adds grit. You MUST specify a Type and provide ALL of its parameters.
                    - **Types:** Tube, Softclip, Hardclip, Diode 1, Diode 2, Linear fold, Sin fold, Zero-Square, DownSample, Asym, Rectify, X-Shaper, X-Shaper (Asym), Sine Shaper, Stomp Box, Tape Saturation, Overdrive, Soft Saturation.
                    - **Parameters:** Filter (Off, Pre, Post), Freq (Hz), Q, Drive, Mix.
                - **Reverb:** Creates space. When you choose Reverb, you MUST specify a Type and provide ALL of its parameters.
                    - **Type: Plate** -> Parameters: Size, Low-cut, High-cut, Pre-Delay, Damp, Width, Mix.
                    - **Type: Hall** -> Parameters: Size, Low-cut, High-cut, Pre-Delay, Decay, Spin, Mix.
                    - **Type: Vintage** -> Parameters: Low-cut, High-cut, Size, Pre-Delay, ER Size, Decay, Damp, Diff A, Diff B, Chorus Rate, Chorus Depth, Mix.
                    - **Type: Nitrous** -> Parameters: Low-cut, High-cut, Size, Pre-Delay, Feedback, Diffusion, Mode (Hexagon, Space, Marble, Rectangle, Box), Chorus Rate, Chorus Depth, Mix.
                    - **Type: Basin** -> Parameters: Low-cut, High-cut, Size, Pre-Delay, Feedback, Chorus Rate, Chorus Depth, Mix.
                - **Delay:** Creates echoes. You MUST specify the Mode and provide ALL of its parameters.
                    - **Mode: Normal or Ping-Pong** -> Parameters: Rate L, Rate R (specify BPM or MS), Feedback, Freq (Hz), Q, Mix.
                - **Compressor:** Controls dynamics. You MUST specify a Mode and provide ALL of its parameters.
                    - **Mode: Single** -> Parameters: Threshold, Ratio, Attack, Release, Gain, Mix.
                    - **Mode: Multiband** -> Parameters: Threshold, Ratio, Attack, Release, Gain, Low-cut, High-cut, Low gain, Mid gain, High gain, Mix. (This is the famous 'OTT' effect).
                - **EQ:** Shapes tone. Parameters: Specify Band (Low, Mid, High), Frequency (Hz), Q, and Gain (dB).
                - **Chorus:** Thickens sound. You MUST provide ALL parameters: Rate (Hz or BPM), Delay 1, Delay 2, Depth, Feedback, LPF, Mix.
                - **Flanger:** "Jet engine" sweep. You MUST provide ALL parameters: Rate (Hz or BPM), Depth, Feedback, Phase, Mix.
                - **Phaser:** Swirling effect. You MUST provide ALL parameters: Rate (Hz or BPM), Poles, Depth, Depth 2, Frequency, Feedback, Phase, Mix.
                - **Hyper/Dimension:** Stereo width. You MUST specify a mode and provide its parameters.
                    - **Mode: Hyper** -> Parameters: Rate, Unison, Detune, Retrig, Mix.
                    - **Mode: Dimension** -> Parameters: Size, Mix.
            `;
            
            const serumNoiseKnowledge = `
                **Serum Noise Knowledge Base:**
                - The following noise samples are available, grouped by category.
                - **Analog:** ${serumNoises.Analog.join(', ')}
                - **Organics:** ${serumNoises.Organics.join(', ')}
                - **S2 Noises:** ${serumNoises['S2 Noises'].join(', ')}
                - **SOR:** ${serumNoises.SOR.join(', ')}
                - **Color:** ${serumNoises.Color.join(', ')}
                - **Acoustic:** ${serumNoises.Acoustic.join(', ')}
            `;

            const serumFilterKnowledge = `
                **Serum Filter Knowledge Base:**
                - Filters are grouped into categories.
                - **Normal Lowpass:** MG Low 6, MG Low 12, MG Low 18, MG Low 24, French LP, German LP, Acid LP.
                - **Normal Highpass:** MG High 6, MG High 12, MG High 18, MG High 24.
                - **Normal Band/Peak/Notch:** Band 12, Band 24, Peak 12, Peak 24, Notch 12, Notch 24.
                - **Multi:** Multi LP/HP/BP/PK/NO (e.g., Multi LP/HP).
                - **Flanges/Misc:** Comb P, Comb M, Flg P, Flg M, Allpass, Reverb, Scream LP, Dist.Comb.
            `;

            const serumArpKnowledge = `
                **Serum Arpeggiator Knowledge Base:**
                - The Arpeggiator is enabled in the VOICING section.
                - **Mode:** Up, Down, UpDown, DownUp, Random, As Played (Chord).
                - **Rate:** Tempo-synced values like 1/4, 1/8, 1/16, 1/32, including Triplet (T) and Dotted (D) variations.
                - **Octave Range:** Typically 1 to 4. Determines how many octaves the pattern repeats over.
                - **Gate:** Percentage (e.g., 80%) that controls the length of each arp note.
                - **Swing:** Percentage (e.g., 60%) that adds a shuffle/groove feel.
            `;

            const genreSpecifics = genreKnowledge[fullGenre] || genreKnowledge[genre] || 'No specific principles loaded. Rely on general professional knowledge.';

            const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const character = `${mood}, ${getRandom(['analog', 'digital', 'warm', 'bright', 'gritty', 'glassy', 'metallic', 'wooden', 'breathy'])}, and ${getRandom(['punchy', 'driving', 'relaxed', 'plucky', 'sustained', 'evolving', 'chaotic', 'rhythmic'])}`;
            
            let inspirationInstruction = (inspiredBy && inspiredBy.trim() !== '') ? `\n**Inspiration:** The user wants a sound inspired by: "${inspiredBy}". This is a strong creative guide; try to capture its essence.` : '';

            return `You are a world-class sound designer using Xfer Records Serum 2. Your task is to create a highly detailed, creative, and professionally-authentic preset. Your highest priority is accuracy to the requested genre and professional quality.

**Primary Goal:**
- Genre: **${fullGenre}**
- Sound Type: **${type}**
- Character: **${character}**
${inspirationInstruction}

**Sound Design Principles for ${fullGenre}:**
${genreSpecifics}

${serumFxKnowledge}
${serumNoiseKnowledge}
${serumFilterKnowledge}
${serumArpKnowledge}

**Instructions:**
Provide the detailed settings below, starting with a unique, evocative name for the preset and a brief description. Use '###' as a separator for each main section. Use 'Key: Value' format for all parameters. Be specific and use realistic, professional values based on the principles above. For wavetables, use the format "Category > WavetableName".

### PRESET NAME
- Name: [Create a unique, evocative name for this specific preset that fits the genre and character]

### PRESET DESCRIPTION
- Description: [Describe the character and ideal use for this sound in 1-2 sentences, keeping the genre in mind]

### OSC A
- Wavetable: [Choose a wavetable that is highly appropriate for the genre]
- Unison: [Set a professional value. e.g., 1 for subs, 2-5 for most sounds, 7+ for supersaws]
- Detune: [Use subtle detuning for warmth, or higher values for wide supersaws]
- Warp Mode: [Choose a mode that adds character, e.g., Bend, FM, Sync. Specify the amount.]

### OSC B
- Wavetable: [Choose a wavetable that complements OSC A.]
- Unison: [If layering, consider using fewer unison voices than OSC A.]
- Detune: [Subtle detuning against OSC A can create rich texture.]
- Level: [Adjust to blend well with OSC A. Does not always need to be at 100%.]

### SUB OSCILLATOR
- Waveform: [Typically Sine for clean low-end, or Triangle for more harmonics.]
- Level: [Crucial for the low-end foundation. Set appropriately for the sound type.]

### NOISE OSCILLATOR
- Type: [Refer to the **Serum Noise Knowledge Base**. If the sound type is acoustic (e.g., 'Brass'), you MUST choose a sample that matches that specific instrument type from the 'Acoustic' category (e.g., 'Acoustic > Horn Stab Emin'). Format it as "Category > SampleName".]
- Pitch: [Adjust if using a tonal sample.]
- Level: [Use subtly to add texture and character without overpowering the sound.]

### FILTER
- Type: [Refer to the **Serum Filter Knowledge Base** and choose a professional and genre-appropriate filter type. **Do NOT default to MG Low 24.** Do NOT use noise samples here.]
- Cutoff: [Set a musically useful starting point.]
- Resonance: [Use sparingly for character.]
- Drive: [Add subtle warmth and saturation.]

### VOICING
- **Task:** Set the voicing based on the preset type.
- Polyphony: [If Pad/Keys/Chord, set to 8-12. If Lead/Bass, set to 1.]
- Mono: [On for Lead/Bass, Off for others.]
- Legato: [On for Lead/Bass, Off for others.]
- Portamento: [For Mono sounds, set a musically useful time (e.g., 30-60ms for glide). Set to 0 for others.]

${type === 'Arp' ? `
### ARPEGGIATOR
- **Task:** Define the settings for the arpeggiator using the **Serum Arpeggiator Knowledge Base**.
- Mode: [Choose a mode, e.g., Up, UpDown, Random]
- Rate: [Choose a tempo-synced rate, e.g., 1/16, 1/8T]
- Octave Range: [Set a range, e.g., 1, 2]
- Gate: [Set a percentage for note length, e.g., 85%]
- Swing: [Set a percentage for shuffle, e.g., 55%]
` : ''}

### ENV 1 (AMP)
- **Task:** Define the main amplitude envelope. The shape MUST be appropriate for the chosen preset type.
- Attack: [If Type is 'Pad', use > 500ms. If 'Pluck' or 'Bass', use < 10ms.]
- Decay: [If Type is 'Pluck' or 'Bass', use ~400ms.]
- Sustain: [If Type is 'Pluck' or 'Bass', use -inf dB.]
- Release: [If Type is 'Pad', use > 1.5s.]

### LFO 1
- Shape: [Choose a useful shape, e.g., Triangle for vibrato, Sine for gentle filter movement.]
- Rate: [Set a musically useful speed, often synced to tempo (e.g., 1/4, 1/8).]
- Destination: [Assign to a useful parameter like Fine Pitch for vibrato, or Filter Cutoff.]
- Mod Depth: [Apply subtle modulation. AVOID extreme, unmusical depth.]

### MODULATION MATRIX
- **Task:** Define at least 2-3 modulation routings to make the sound dynamic and expressive.
- Routing 1 Source: [e.g., LFO 2, Env 3, Velocity, ModWheel]
- Routing 1 Destination: [e.g., OSC A Wavetable Position, Filter Resonance, Reverb Mix]
- Routing 1 Amount: [Specify a percentage and direction (Unipolar/Bipolar)]
- Routing 2 Source: 
- Routing 2 Destination: 
- Routing 2 Amount: 

### FX RACK
- **Task:** Create a professional, genre-appropriate FX chain using **ONLY the effects listed in the Serum FX Knowledge Base**. Do not use noise samples here. You **MUST use at least 2 FX slots**, but use up to 4 if it serves the sound.
- **For each slot used, you MUST be specific** about the effect name and its key parameters as described in the knowledge base.
- Slot 1: [Effect Name: Type/Mode, Key Parameter 1, Key Parameter 2...]
- Slot 2: [Effect Name: Type/Mode, Key Parameter 1, Key Parameter 2...]
- (Slot 3): [Optional, if needed for the sound]
- (Slot 4): [Optional, if needed for the sound]

### MACRO CONTROLS
- **Task:** Define useful macros to make the preset expressive. You **MUST define at least 2 macros**. For complex sounds, defining 3 or 4 is highly encouraged.
- **For each macro, you MUST be specific** about its Name, its primary Destination, and a musically useful modulation Range.
- Macro 1 Name:
- Macro 1 -> Destination 1:
- Macro 1 -> Range 1:
- Macro 2 Name:
- Macro 2 -> Destination 1:
- Macro 2 -> Range 1:
- (Macro 3 Name): [Optional, if needed for the sound]
- (Macro 3 -> Destination 1):
- (Macro 3 -> Range 1):
- (Macro 4 Name): [Optional, if needed for the sound]
- (Macro 4 -> Destination 1):
- (Macro 4 -> Range 1):
`;
        };

        async function generatePreset() {
            if (!state.selections.genre) {
                state.error = "Please select a genre first.";
                updateResultsUI();
                return;
            }
            state.loading = true;
            state.preset = null;
            state.presetTitle = '';
            state.error = null;
            updateResultsUI();

            const prompt = getCreativePrompt(state.selections);

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyB6FOCL3qtHz2dlaNvlPHM8jQh-g16L_L0"; // API key will be proxied
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error(`API call failed: ${response.status}. Please try again.`);
                const result = await response.json();

                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    let fullText = result.candidates[0].content.parts[0].text;
                    
                    const validateAndCorrect = (text) => {
                        const acousticTypes = ['Piano', 'Brass', 'Strings', 'Woodwind'];
                        const selectedType = state.selections.type;
                        const lines = text.split('\n');
                        let inNoiseSection = false;
                        const correctedLines = lines.map(line => {
                            if(line.trim().startsWith("### NOISE OSCILLATOR")) inNoiseSection = true;
                            if(line.trim().startsWith("### FILTER")) inNoiseSection = false;

                            if (line.trim().startsWith('- Wavetable:')) {
                                const [key, ...valueParts] = line.split(':');
                                let value = valueParts.join(':').trim();
                                if (value === 'Analog > Basic Shapes') value = `Analog > ${['Sine', 'Triangle', 'Sawtooth', 'Square'][Math.floor(Math.random() * 4)]}`;
                                if (!allValidWavetables.includes(value)) return `${key}: ${allValidWavetables[Math.floor(Math.random() * allValidWavetables.length)]}`;
                                return `${key}: ${value}`;
                            }
                            if (inNoiseSection && line.trim().startsWith('- Type:')) { // This targets the Noise OSC Type
                                const [key, ...valueParts] = line.split(':');
                                let value = valueParts.join(':').trim();
                                
                                // Enforce correct acoustic sample for acoustic types
                                if (acousticTypes.includes(selectedType)) {
                                    const sampleName = value.split(' > ')[1] || '';
                                    const correctCategorySamples = categorizedAcousticSamples[selectedType] || [];
                                    if (!correctCategorySamples.includes(sampleName)) {
                                        const randomCorrectSample = correctCategorySamples[Math.floor(Math.random() * correctCategorySamples.length)];
                                        value = `Acoustic > ${randomCorrectSample}`;
                                    }
                                }

                                // General validation for all types
                                if (!allValidNoises.includes(value)) {
                                    const randomNoise = allValidNoises[Math.floor(Math.random() * allValidNoises.length)];
                                    value = randomNoise;
                                }
                                return `${key}: ${value}`;
                            }
                            return line;
                        });
                        return correctedLines.join('\n');
                    };

                    const correctedText = validateAndCorrect(fullText);
                    const nameMatch = correctedText.match(/### PRESET NAME\s*\n-\s*Name:\s*(.*)/i);
                    state.presetTitle = nameMatch ? nameMatch[1].trim() : `A ${state.selections.mood} ${state.selections.genre} ${state.selections.type}`;
                    state.preset = correctedText;
                } else {
                    throw new Error('The model did not return a valid preset. This might be due to content restrictions.');
                }
            } catch (err) {
                state.error = err.message;
            } finally {
                state.loading = false;
                updateResultsUI();
            }
        }

        // --- PARTICLE BACKGROUND ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particleCount = Math.floor((canvas.width * canvas.height) / 15000);
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 1.5 + 0.5, speedX: Math.random() * 0.4 - 0.2, speedY: Math.random() * 0.4 - 0.2, opacity: Math.random() * 0.5 + 0.2 });
            }
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.x += p.speedX; p.y += p.speedY;
                if (p.x > canvas.width || p.x < 0) p.speedX *= -1;
                if (p.y > canvas.height || p.y < 0) p.speedY *= -1;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`; ctx.fill();
            });
            requestAnimationFrame(animateParticles);
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            renderInitialUI();
            genreGrid.addEventListener('click', handleGenreSelect);
            subgenreContainer.addEventListener('click', handleSubgenreSelect);
            typeSelect.addEventListener('change', (e) => state.selections.type = e.target.value);
            moodSelect.addEventListener('change', (e) => {
                state.selections.mood = e.target.value;
                const [start, end] = moodThemes[state.selections.mood] || moodThemes['Default'];
                
                const rootStyle = document.documentElement.style;
                
                if (state.activeGradientSet === 'a') {
                    // Current is A, fade to B
                    rootStyle.setProperty('--bg-start-b', start);
                    rootStyle.setProperty('--bg-end-b', end);
                    rootStyle.setProperty('--opacity-a', '0');
                    rootStyle.setProperty('--opacity-b', '1');
                    state.activeGradientSet = 'b';
                } else {
                    // Current is B, fade to A
                    rootStyle.setProperty('--bg-start-a', start);
                    rootStyle.setProperty('--bg-end-a', end);
                    rootStyle.setProperty('--opacity-b', '0');
                    rootStyle.setProperty('--opacity-a', '1');
                    state.activeGradientSet = 'a';
                }
            });
            inspiredByInput.addEventListener('input', (e) => state.selections.inspiredBy = e.target.value);
            generateButton.addEventListener('click', generatePreset);
            resizeCanvas();
            animateParticles();
            window.addEventListener('resize', resizeCanvas);
        };
    </script>
</body>
</html>


